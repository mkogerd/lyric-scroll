<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" type="text/css" href="stylesheet.css">
	</head>
	<body>
		<textarea id='textarea_id'>
Hallelujah
Leonard Cohen

Now, I've heard there was a secret chord
That David played, and it pleased the Lord
But you don't really care for music, do you?
It goes like this, the fourth, the fifth
The minor fall, the major lift
The baffled king composing hallelujah
Hallelujah
Hallelujah
Hallelujah
Hallelujah
Your faith was strong but you needed proof
You saw her bathing on the roof
Her beauty and the moonlight overthrew ya
She tied you to a kitchen chair
She broke your throne, and she cut your hair
And from your lips she drew the hallelujah
Hallelujah
Hallelujah
Hallelujah
Hallelujah
You say I took the name in vain
I don't even know the name
But if I did, well really, what's it to you?
There's a blaze of light in every word
It doesn't matter which you heard
The holy or the broken hallelujah
Hallelujah
Hallelujah
Hallelujah
Hallelujah
I did my best, it wasn't much
I couldn't feel, so I tried to touch
I've told the truth, I didn't come to fool you
And even though it all went wrong
I'll stand before the lord of song
With nothing on my tongue but hallelujah
Hallelujah
Hallelujah
Hallelujah
Hallelujah
Hallelujah
Hallelujah
Hallelujah
Hallelujah
Hallelujah
Hallelujah
Hallelujah
Hallelujah
Hallelujah
Hallelujah
Hallelujah
Hallelujah
Hallelujah
Hallelujah

		</textarea>
		<div class="stats statsform">
			<form>
				Beats per measure:
				<input type="text" id="beatspermeasure" name="beatspermeasure" value="4" onchange="updateBeatsPerMeasure()" oninput="updateBeatsPerMeasure()"><br>
				Beats per minute:
				<input type="text" id="bpm" name="bpm" value="60" onchange="updateBeatsPerMeasure()" oninput="updateBeatsPerMeasure()"><br>
				<input type="range" id="speed" value="75" min="1" onchange="updateBeatsPerMeasure()" oninput="updateBeatsPerMeasure()">
			</form>
		</div>
		<div class="stats" id="debug1">
		</div>
		<div class="stats" id="debug2">
		</div>
		<div class="stats" id="debug3">
			<div class="metronome" id="metronome"></div>
		</div>
		
		
		
	</body>
</html>
<script>
	// Variables
	var scroll = false;
	var textarea = document.getElementById('textarea_id');
	var lineHeight = parseInt(window.getComputedStyle(textarea).getPropertyValue('line-height'), 10); // Line height in pixels
	var tstart, tend, count, tpb, tpl;
	var bpm = document.getElementById('bpm').value;
	var beatspermeasure = document.getElementById('beatspermeasure').value;
	var percentSpeed = document.getElementById('speed').value;
	updateCalculations(0);							// Initialization
	
	// Keypress logic
	document.body.onkeyup = function(e){
		if(e.keyCode == 66){						// 'b' key takes in tempo
			if((new Date()).getTime()-tend > 2000 || !tstart){ // If first tap or over 2 seconds has ellapsed since last tempo tap, grab a new start time
				tstart= (new Date()).getTime();
				tend = tstart;
				scroll = false;
				count = 0;
			}
			else {
				tend = (new Date()).getTime();
				count++;
			}
			updateCalculations(1);
		}
		if(e.keyCode == 32){						// 'space' key toggles scrolling
			scroll = !scroll;
			if(scroll){
			metronome();
				tpl = tpb*beatspermeasure;			// Calculate time per line
				run();
			}
		}
	} 
	
	// Scrolling Function
	function run(){
		textarea.scrollTop += 1;
		if(scroll){
			window.setTimeout(run, (100/percentSpeed)*(tpl/lineHeight));	// Traverse one line per "Time per line"
		}
	}
	
	// Update Calculations (0 for input boxes, 1 for tap-input)
	function updateCalculations(keyinput){
			if(keyinput){
				tpb = (tend-tstart)/count;					// Calculate time per beat (ms)
				bpm = 60*1000/tpb;							// Calculate beats per minute
				document.getElementById('bpm').value=bpm;	// Update input value
			}
			else
				tpb = 60*1000/bpm;							// Calculate time per beat
	}
	
	// Update input
	function updateBeatsPerMeasure(){
	bpm = document.getElementById('bpm').value;
		beatspermeasure = document.getElementById('beatspermeasure').value;	// Update beats per measure
		percentSpeed = document.getElementById('speed').value;				// Update speed modifier
		updateCalculations(0);
	}
	
	
	// Blink Metronome
	function metronome(){
		document.getElementById('metronome').style.backgroundColor="cyan";
		setTimeout(blink, tpb/10);
		if(scroll){
			window.setTimeout(metronome, tpb);	// Traverse one line per "Time per line"
		}
	}
	function blink(){
		document.getElementById('metronome').style.backgroundColor="gray";
	}
	
	// Debugging Info
	setInterval(function(){
		document.getElementById("debug1").innerHTML = "count: "+count+"<br>scroll: "+scroll+"<br>Line-Height: "+lineHeight+"px"+"<br>Speed%: "+percentSpeed;
		document.getElementById("debug2").innerHTML = "bpm: "+bpm + "<br>milliseconds per beat: "+tpb+"<br>milliseconds per line: "+tpl+"<br>Beats per measure: "+beatspermeasure+"<br>ms per beat: "+tpb;
		if (scroll){
			//textarea.scrollTop += 1;
			var dif = Number(t2) - Number(t1);
			//textarea.value+=(t1-t2)+' '+count+'\n';
			//textarea.scrollTop = textarea.scrollHeight;
		}
	}, 10);
</script>